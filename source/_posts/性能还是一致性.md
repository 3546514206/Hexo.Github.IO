---
title: 性能还是一致性？
date: 2025-01-16 15:10:58
tags:
- 设计
---

&ensp;&ensp;&ensp;&ensp; 在握手式国密通讯的机制中，正常逻辑如流程一所示：

![流程一](/pic/工程/性能还是一致性/流程一.png)

&ensp;&ensp;&ensp;&ensp; 上述流程中，服务端来判断 token 是否有效，如果失效会告知客户端，客户端需重新握手协商工作秘钥，并重发请求三。 屹通认为重发是一种性能浪费，于是做了如下流程二的“优化”：

![流程二](/pic/工程/性能还是一致性/流程二.png)

&ensp;&ensp;&ensp;&ensp; 客户端根据握手接口返回的时间戳以及 token 有效时间自行判断 token 是否还有效。尽管屹通这里的 timestamp +  expiration 计算的是绝对时间，但是仍然可能存在如下问题：

&ensp;&ensp;&ensp;&ensp; __服务端在反馈了握手请求之后重新 ntp 导致客户端的时间戳不准确的问题；__

&ensp;&ensp;&ensp;&ensp; __服务端意外删除缓存起来的 token 对应的工作秘钥，但是客户端并不知道。__

&ensp;&ensp;&ensp;&ensp; 严谨地说，token 是否有效，服务端有着绝对的话语权；即便是重发请求的场景，也屡见不鲜，屹通这种优化，是否必要？

&ensp;&ensp;&ensp;&ensp; PS：我后来从客户端了解到，如果用户修改了手机时间，一样会导致客户端的时间戳发生改变，进而导致客户端和服务端的时间戳不同步。这样的话，就毫无悬念，可以将屹通的这种设计，判定为画蛇添足的做法。